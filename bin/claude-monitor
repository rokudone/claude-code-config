#!/bin/bash

# ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
active_count=0
idle_count=0
total_count=0

# è©³ç´°æƒ…å ±ã‚’æ ¼ç´
details=""

# æœ€å¤§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåé•·ã¨Gitæƒ…å ±é•·ã‚’æ ¼ç´
max_project_len=0
max_git_len=0

# ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆpgrep -xã§æ­£ç¢ºã«"claude"ã®ã¿ï¼‰
for pid in $(pgrep -x claude | sort -u); do
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
    dir=$(lsof -p $pid 2>&1 | grep -v "ERR:" | grep cwd | awk '{print $NF}' | head -1)
    [ -z "$dir" ] || [ "$dir" = "/" ] && continue
    
    # CPUä½¿ç”¨ç‡ã‚’å–å¾—
    cpu=$(ps -p $pid -o %cpu= 2>/dev/null | tr -d ' ')
    [ -z "$cpu" ] && continue
    
    ((total_count++))
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨CPUä½¿ç”¨ç‡
    project=$(basename "$dir")
    
    # CPUä½¿ç”¨ç‡ã®æ•´æ•°éƒ¨åˆ†ã‚’å–å¾—ï¼ˆå°æ•°ç‚¹å‡¦ç†ã‚’ç¢ºå®Ÿã«ï¼‰
    cpu_int=$(echo "$cpu" | cut -d'.' -f1)
    [ -z "$cpu_int" ] && cpu_int=0
    
    # Gitæƒ…å ±ã‚’å–å¾—
    git_info=""
    if [ -d "$dir/.git" ]; then
        branch=$(cd "$dir" && git branch --show-current 2>/dev/null)
        changes=$(cd "$dir" && git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
        if [ -n "$branch" ]; then
            git_info=" [$branch"
            [ "$changes" != "0" ] && [ -n "$changes" ] && git_info="${git_info} +$changes"
            git_info="${git_info}]"
        fi
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨Gitæƒ…å ±ã®é•·ã•ã‚’å€‹åˆ¥ã«è¨ˆç®—
    project_len=${#project}
    [ $project_len -gt $max_project_len ] && max_project_len=$project_len
    git_len=${#git_info}
    [ $git_len -gt $max_git_len ] && max_git_len=$git_len
    
    # çŠ¶æ…‹åˆ¤å®šã¨è©³ç´°ä½œæˆï¼ˆä¸€æ™‚çš„ã«ä¿å­˜ï¼‰
    if [ "$cpu_int" -gt 1 ]; then
        ((active_count++))
        details="${details}ğŸ”µ|${project}|${git_info}|\n"
    else
        ((idle_count++))
        # å¾…æ©Ÿæ™‚é–“ã‚’è¨ˆç®—ï¼ˆç°¡æš—ç‰ˆï¼‰
        idle_time_file="/tmp/claude-idle-$pid"
        if [ ! -f "$idle_time_file" ]; then
            date +%s > "$idle_time_file"
            time_str="(é–‹å§‹)"
        else
            start_time=$(cat "$idle_time_file")
            current_time=$(date +%s)
            idle_seconds=$((current_time - start_time))
            
            if [ $idle_seconds -lt 60 ]; then
                time_str="(${idle_seconds}s)"
            elif [ $idle_seconds -lt 3600 ]; then
                minutes=$((idle_seconds / 60))
                seconds=$((idle_seconds % 60))
                time_str="(${minutes}m${seconds}s)"
            else
                hours=$((idle_seconds / 3600))
                minutes=$(((idle_seconds % 3600) / 60))
                time_str="(${hours}h${minutes}m)"
            fi
        fi
        details="${details}ğŸ”´|${project}|${git_info}|${time_str}\n"
    fi
done

# ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ­ã‚»ã‚¹ã®å¾…æ©Ÿæ™‚é–“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
for idle_file in /tmp/claude-idle-*; do
    [ -f "$idle_file" ] || continue
    pid=$(basename "$idle_file" | cut -d'-' -f3)
    # ãƒ—ãƒ­ã‚»ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! kill -0 $pid 2>/dev/null; then
        rm -f "$idle_file"
    else
        # CPUãŒé«˜ã„å ´åˆã‚‚ã‚¯ãƒªã‚¢
        cpu_check=$(ps -p $pid -o %cpu= 2>/dev/null | tr -d ' ')
        if [ -n "$cpu_check" ]; then
            cpu_int_check=$(echo "$cpu_check" | cut -d'.' -f1)
            [ "$cpu_int_check" -gt 1 ] 2>/dev/null && rm -f "$idle_file"
        fi
    fi
done

# ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã«è¡¨ç¤º
if [ $total_count -eq 0 ]; then
    echo "Claude: ãªã—"
    echo "---"
    echo "ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
else
    # ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
    echo "Claude: ğŸ”µ${active_count} ğŸ”´${idle_count}"
    echo "---"
    
    # æœ€å°å¹…ã‚’è¨­å®š
    [ $max_project_len -lt 20 ] && max_project_len=20
    [ $max_git_len -lt 15 ] && max_git_len=15
    
    # è©³ç´°ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦è¡¨ç¤º
    echo -e "$details" | sort -t'|' -k2 | while IFS='|' read -r emoji project git_info time_str; do
        if [ -n "$emoji" ]; then
            # Gitæƒ…å ±ãŒãªã„å ´åˆã¯ç©ºç™½ã§åŸ‹ã‚ã‚‹
            [ -z "$git_info" ] && git_info=" "
            if [ -n "$time_str" ]; then
                printf "%-2s %-${max_project_len}s %-${max_git_len}s %s\n" "$emoji" "$project" "$git_info" "$time_str"
            else
                printf "%-2s %-${max_project_len}s %s\n" "$emoji" "$project" "$git_info"
            fi
        fi
    done
    
    echo "---"
    echo "åˆè¨ˆ: ${total_count}"
fi

# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
echo "---"
