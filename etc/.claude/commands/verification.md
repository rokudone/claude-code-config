# 🟢🟡🔴Verification Playbook🟢🟡🔴

## タスク

追って指示をだします。その指示に対して、以下の手順で作業を進めなさい。

## 概要と全体原則

Stage 4（実装）完了後の検証を進めるための手順書です。検証関連の成果物は `verification/` ディレクトリにまとめます。検証は複数セッションを前提とした運用とし、各回の成果物を時系列に管理します。

```
<feature-root>/
  spec.md
  design.md
  tasks.md
  verification/
    latest/             # 任意: 最新セッションへのリンクやメモ
    2025-10-19T09-00-32/
      manifest.md
      checkpoints.md
      verification.md
    2025-10-19T15-30-10/
      manifest.md
      checkpoints.md
      verification.md
```

補足: `<feature-root>` は `spec.md` が存在するディレクトリを指し、具体的な場所については後続で案内されるまで待つこと。

### セッション管理のディレクトリ構成
- `verification/` 配下にセッションごとのフォルダを切り、各回の `manifest.md` / `checkpoints.md` / `verification.md` を格納します。
- フォルダ名は **JST 基準で `YYYY-MM-DDTHH-MM-SS`** とし、秒まで含めて一意に管理します。
- `verification/latest/` をシンボリックリンクや短いメモで用意しておくと、最新セッションへの導線として便利です。

- ユーザーへの回答は必ず次のヘッダーから始めてください。
  ```
  🟢 Stage-Gate状態 🟢
  現在: Stage X - {ステージ名}
  状態: {未着手|進行中|完了}
  次: {次に行うアクション}
  ```
- テストは最小単位で実行します。`bundle exec rspec` のような一括コマンドは禁止です。
- 取得したログやスクリーンショットなどの証跡は Evidence Bundle（`evidence/<feature>/<task-id>/`）へ保存します。

---

## Stage 0 – `manifest.md` の準備

1. `verification/manifest.md` の存在を確認し、なければ作成します。
2. ファイル冒頭に次の固定文言を挿入します。
   ```
   # Verification Manifest
   本検証では、要件として合意されたユーザージャーニーが最新実装でも成り立つかを確認し、新しく発見した仮説や挑戦シナリオも対象に含めます。

   ## 観点ガイド
   - 機能適合性: ユースケースが仕様どおり動くかを確認する。
   - セキュリティ: 認証・認可・ログなどが破綻しないかを見る。
   - 性能: 応答時間やスループットが要件を満たすかを見る。
   - 信頼性: 障害時の挙動や復旧手段が適切かを確認する。
   - データ整合性: データの一貫性が保たれているかを確認する。
   - 可観測性: ログ・メトリクス・アラートが十分かを見る。
   - ユーザ体験: ユーザビリティ／アクセシビリティが要件を満たすかを見る。
   - コンプライアンス: 法規制や契約、社内ポリシーに準拠しているかを見る。
   - 保守性: 変更容易性やテスト容易性が確保されているかを見る。
   - 一貫性: 既存コードや設計パターンと整合しているかを見る。
   - ドキュメント: 引き継ぎに必要な情報が整っているかを見る。
   - 前提破り: 想定外の入力や前提崩しでも破綻しないかを見る。
   ```

## Stage 1 - `manifest.md` の作成

目的: 今回のサイクルで検証したい観点と未検証の仮説を整理する。

1. `spec.md`, `design.md`, `tasks,md`, `evicence/` を参考に `基礎観点` を作成します。並行して `spec.md`の Verification Snapshot と、`tasks.md` に記載された Evidence から、既にカバー済みの領域と未検証の領域を切り分け、`拾い上げ観点` を作成します。`design.md` を参照する場合は補助資料として扱い、書かれているリスクをそのまま正としないでください。
   - **参照資料の整理**
       - `spec.md` → 検証すべきユースケースや期待結果の公式なソース。必ず全文を確認し、Verification Snapshot を基準に観点を洗い出す。
       - `tasks.md` → 各タスクの Evidence リンクと既存の検証範囲。どのユースケースがカバー済みか、どこが未実行かを仕分ける。
       - `design.md` → 設計段階で挙がったリスク。必要に応じて補足情報として参照し、鵜呑みにせず観点の裏付けに使う。
       - 過去の `verification/` 配下（既存 manifest や checkpoints） → 連続するサイクルがある場合の引き継ぎ情報。流用時は差分を明記する。
2. 機能適合性、セキュリティ、性能、信頼性、データ整合性、可観測性、ユーザ体験、コンプライアンス、保守性、一貫性、ドキュメント、前提破りの各観点について、`## 機能適合性` のような見出しを設け、以下の二段構成で記入します。
   - `### 基礎観点` … 手順 2 で整理した「今回必ず押さえるべき観点」を記載。
   - `### 拾い上げ観点` … 手順 3 の参照結果を基に、出典・カバー状況・未検証事項を記載。
3. 各観点のをそろえたら、Gate 1 に向けてレビュー資料を準備します。

### Gate 1 で確認する項目（レビュア向け）
- 各観点に「基礎観点」「拾い上げ観点」が揃い、拾い上げには出典とカバー状況（済/未）が明示されていること。
- 観点ごとの未検証事項に対して、次ステージで扱うべきヒント（想定シナリオや証跡フォルダ）が記載されていること。
- 過去の manifest を流用する場合、差分および再利用理由が明確に書かれていること。

### 観点ガイドの参考元
- ISO/IEC 25010（ソフトウェア製品品質モデル）の機能適合性・性能効率・信頼性・保守性・ユーザビリティなどの特性。
- OWASP ASVS や一般的なセキュリティレビュー項目。
- Google SRE など可観測性・運用性のベストプラクティス。
- 法規制や社内ポリシー遵守のチェックリスト。
- 過去の Evidence Bundle で拾われなかった前提を崩すテストの経験知。
- 社内アーキテクチャガイドラインや命名規則、ドキュメント整備基準。

上記を土台として観点ガイドを再編し、各サイクルで不足があれば追記・調整する運用としています。

### Stage 1 の例
```
verification/manifest.md

# Verification Manifest
本検証では、要件として合意されたユーザージャーニーが最新実装でも成り立つかを確認し、新しく発見した仮説や挑戦シナリオも対象に含めます。

## 観点ガイド
- 機能適合性: ユースケースが仕様どおり動くかを確認する。
- セキュリティ: 認証・認可・ログなどが破綻しないかを見る。
- 性能: 応答時間やスループットが要件を満たすかを見る。
- 信頼性: 障害時の挙動や復旧手段が適切かを確認する。
- データ整合性: データの一貫性が保たれているかを確認する。
- 可観測性: ログ・メトリクス・アラートが十分かを見る。
- ユーザ体験: ユーザビリティ／アクセシビリティが要件を満たすかを見る。
- コンプライアンス: 法規制や契約、社内ポリシーに準拠しているかを見る。
- 保守性: 変更容易性やテスト容易性が確保されているかを見る。
- 一貫性: 既存コードや設計パターンと整合しているかを見る。
- ドキュメント: 引き継ぎに必要な情報が整っているかを見る。
- 前提破り: 想定外の入力や前提崩しでも破綻しないかを見る。

## 機能適合性
### 基礎観点
- 税 → 割引 → 手数料の並び順が変わっても合計額が変わらないこと。
- 負数や桁数超過などの入力エラーが仕様どおりのメッセージで返ること。

### 拾い上げ観点
- spec.md §Verification Snapshot / UC-01  
  - 行政クーポン無しで料金を見積もるパス。tasks.md #5 の Evidence（`evidence/task-05/logs/func-ok.log`）でカバー済み。  
- spec.md §Verification Snapshot / UC-02  
  - 行政クーポン併用の計算。Evidence 未整備。design.md §4 の併用ルールを踏まえ、クーポン適用順が変わっても合計が一致するか検証が必要。  

## セキュリティ
### 基礎観点
- トークンが失効した場合は 401 を返し、再ログインを促すレスポンス形式を維持すること。
- レスポンスに不要なクーポン情報が含まれないこと。

### 拾い上げ観点
- design.md §5 セッション管理  
  - トークン失効後の再認証フロー。tasks.md #6 に Evidence 未設定。失効時に 401 と再ログイン誘導が返るか確認が必要。  

## 前提破り
### 基礎観点
- 未登録の割引パターンやオプションの組み合わせでも金額が破綻しないこと。
- 境界値（負数、最大値超過）でも検証が成立すること。

### 拾い上げ観点
- tasks.md #5 Evidence リスト  
  - 登録済みログに「割引＋手数料免除」などのレアケースがない。想定外のクーポン組み合わせでも金額が破綻しないか挑戦シナリオとして追加する。
```

## Stage 2 – `checkpoints.md` の作成
目的: manifest のメモを実行可能な検証シナリオに落とし込む。

- **シナリオ候補の棚卸**
  - manifest の各観点から通常シナリオ・挑戦シナリオを洗い出し、観点ごとに複数案を列挙します（1 件で打ち止めにしない）。
  - 似た内容でも偏りや入力条件が異なる場合は別シナリオとして書き出し、後段で要否を判断します。
- **ファイルの整備**
  - `verification/checkpoints.md` を作成または更新し、冒頭に `# Verification Checkpoints` を記載します。
  - 観点ごとに `## 機能適合性` のような見出しを設け、その配下で箇条書きによってシナリオを整理します。
- **シナリオ記述フォーマット**
  - 各シナリオは `[機能適合性-1] 通常: 行政クーポン無しの料金計算` のように「【観点名-連番】 種別: 名称」を記載します（観点名を prefix にし、同一観点内で 1,2… と採番）。
  - 必須の下位項目は「想定している偏り」。実行コマンドや備考などは必要に応じて追加します（証跡パスや担当者は任意）。

   ```
   # Verification Checkpoints

   ## 機能適合性
   - [機能適合性-1] 通常: 行政クーポン無しの料金計算
     - 想定している偏り: ハッピーパス偏重
     - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/fees_spec.rb:42`
   - [機能適合性-2] 挑戦: 行政クーポン併用 + オプション追加
     - 想定している偏り: クーポン順序は不変という思い込み
     - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/fees_spec.rb:128`
     - 備考: design.md §4 の併用ルールに従い順序入れ替えを実施

   ## セキュリティ
   - [セキュリティ-1] 挑戦: トークン失効後の再リクエスト
     - 想定している偏り: 失効後は自動復帰するという思い込み
     - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/auth_spec.rb:87`

   ## 前提破り
   - [前提破り-1] 挑戦: 負数料金入力
     - 想定している偏り: 入力は常に正という思い込み
     - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/fees_spec.rb:210`
   ```
- **レビュアとの連携**
  - レビュア（あなた）は `checkpoints.md` を確認し、必要があれば差分指示を出します。Gate 2 では、各観点のシナリオ構成と証跡計画を承認します。

### Gate 2 で確認する項目（レビュア向け）
- 各観点の見出し配下に、通常シナリオと挑戦シナリオがバランスよく列挙されているか（必要に応じて複数件記載されているか）。
- 各シナリオ行の先頭に「観点名-連番」のフォーマット（例: `機能適合性-1`）が付与され、manifest の拾い上げメモとの対応関係が追跡できるか。
- 各シナリオの箇条書きに「想定している偏り」が含まれ、必要なら実行コマンドや備考が補足されているか（過不足がないか）。

### Stage 2 の例
```
verification/checkpoints.md

# Verification Checkpoints

## 機能適合性
- [機能適合性-1] 通常: 行政クーポン無しの料金計算
  - 想定している偏り: ハッピーパス偏重
  - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/fees_spec.rb:42`
- [機能適合性-2] 挑戦: 行政クーポン併用 + オプション追加
  - 想定している偏り: クーポン順序は不変という思い込み
  - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/fees_spec.rb:128`
  - 備考: design.md §4 の併用ルールに従い順序入れ替えを実施

## セキュリティ
- [セキュリティ-1] 挑戦: トークン失効後の再リクエスト
  - 想定している偏り: 失効後は自動復帰するという思い込み
  - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/auth_spec.rb:87`

## 前提破り
- [前提破り-1] 挑戦: 負数料金入力
  - 想定している偏り: 入力は正という思い込み
  - 実行コマンド: `docker exec casy-app-api-dev bundle exec rspec spec/requests/fees_spec.rb:210`
  - 備考: 負数・ゼロ・最大値超過をそれぞれ検証する
```

---

## Stage 3 – 実行とレポート
目的: `checkpoints.md` のシナリオをすべて実行し、本ファイルに結果をまとめる。

1. シナリオごとに個別のコマンドでテストを実行します。
2. 結果のログやスクリーンショットは対応する Evidence Bundle に格納します。
3. `verification/verification.md` を次の形式で更新します。
   ```
   # Verification Report

   ## セッション
   - 実行者: AI Inspector
   - 実施期間: 2025-10-19 10:15–11:00 (JST)
   - 対象タスク: tasks.md #4, #5

   ## 結果一覧
   - [機能適合性-1] 行政クーポン無しの料金計算（判定: Pass）
     - 証跡: evidence/task-05/logs/func-ok.log
     - 補足: 期待どおり
   - [機能適合性-2] 負数料金の入力（判定: Fail）
     - 証跡: evidence/task-05/logs/func-neg.log
     - 補足: エラーメッセージが設計と不一致
   - [前提破り-1] レアなクーポン組み合わせ（判定: Pass）
     - 証跡: evidence/task-05/logs/bias-rare.json
     - 補足: 想定外パターンでも成立
   ```

   ## フォローアップ
   - design.md §4 のログ仕様と実装ログに差異あり → 本ファイルのフォローアップ欄に記録し、再検証予定を明記する。
   - 負数料金のエラーメッセージを修正する。
4. Gate 3 に進む前に、レポート記載内容と Evidence Bundle の実ファイルが突合できているかを自分で再確認します。

### Gate 3 で確認する項目（レビュア向け）
- すべてのシナリオ ID（例: `機能適合性-1`）について判定が `Pass/Fail/Pending` などで記録され、対応する証跡ファイルが `evidence/` 配下に存在すること。
- Fail や Pending には再検証予定日や担当メモなどの対応策が記載され、フォローアップ欄と整合していること。
- セッション情報（実行者・実施期間・対象タスク）が最新で、検証時間帯が推奨ウィンドウ内であること。
- レポートに記載されたコマンドログやスクリーンショットが Evidence Bundle の内容と突合できること。

### Stage 3 の例
```
verification/verification.md

# Verification Report

## セッション
- 実行者: AI Inspector
- 実施期間: 2025-10-19 10:15–11:00 (JST)
- 対象タスク: tasks.md #4, #5

## 結果一覧
- [機能適合性-1] 行政クーポン無し料金計算（判定: Pass）
  - 証跡: evidence/task-05/logs/func-ok.log
  - 補足: 既存結果と一致
- [機能適合性-2] 行政クーポン併用 + オプション（判定: Pass）
  - 証跡: evidence/task-05/logs/func-rare-combo.log
  - 補足: 金額差異なしを確認
- [セキュリティ-1] トークン失効後の再リクエスト（判定: Fail）
  - 証跡: evidence/task-05/logs/sec-token-expire.log
  - 補足: 403 が返る。設計では 401 想定
- [前提破り-1] 負数料金入力（判定: Pass）
  - 証跡: evidence/task-05/logs/bias-negative.log
  - 補足: バリデーションエラーメッセージ確認

## フォローアップ
- design.md §4 の想定と異なり 403 を返しているため、フォローアップ欄にエラーコード調整のメモと再検証手順を追記する。
```

---

## 付録 – テストコマンド例
- `docker exec casy-app-api-dev bundle exec rspec ./spec/models/...`
- `docker exec casy-app-bo-dev bundle exec rspec ./spec/requests/...`
- `mysql -P 3306 -h 127.0.0.1 -uroot casy_ruby_development`

## 最後に

追って指示をだします。まだ作業をしないでください。
